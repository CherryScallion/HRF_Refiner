# HRF_Refiner æ¨¡å‹çš„æ•°æ®åŠ è½½ä¸å‰å‘ä¼ æ’­è¿‡ç¨‹

## ğŸ“‹ ç›®å½•
1. [æ•°æ®åŠ è½½æµç¨‹](#æ•°æ®åŠ è½½æµç¨‹)
2. [å‰å‘ä¼ æ’­è¿‡ç¨‹](#å‰å‘ä¼ æ’­è¿‡ç¨‹)
3. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)

---

## æ•°æ®åŠ è½½æµç¨‹

### 1. æ•°æ®æºæ ¼å¼

**H5 æ–‡ä»¶ç»“æ„ï¼š**
```
train_data.h5
â”œâ”€â”€ 'pred': [Total_Timepoints, H, W]  # Base Model çš„é¢„æµ‹ç»“æœ
â””â”€â”€ 'gt':   [Total_Timepoints, H, W]  # çœŸå®æ ‡ç­¾ï¼ˆGround Truthï¼‰
```

**ç¤ºä¾‹é…ç½®ï¼š**
- `window_size (T) = 5`ï¼šä½¿ç”¨è¿‡å» 5 å¸§æ¥é¢„æµ‹å½“å‰å¸§
- `Total_Timepoints = 1000`ï¼šæ€»å…± 1000 ä¸ªæ—¶é—´ç‚¹
- `H, W = 64, 64`ï¼šç©ºé—´åˆ†è¾¨ç‡

---

### 2. Dataset ç±»çš„åˆå§‹åŒ–

```python
dataset = FMRI_H5_Dataset(
    h5_path="./data/train_data.h5",
    window_size=5
)
```

**åˆå§‹åŒ–æ­¥éª¤ï¼š**
1. æ‰“å¼€ H5 æ–‡ä»¶ï¼Œè¯»å– `gt` çš„é•¿åº¦ï¼š`self.length = f['gt'].shape[0]`
2. åˆ›å»ºç´¢å¼•åˆ—è¡¨ï¼š`self.full_indices = range(0, length)`ï¼ˆæ”¯æŒé¢„æµ‹æ‰€æœ‰æ—¶é—´ç‚¹ï¼‰
3. æ•°æ®é›†é•¿åº¦ï¼š`len(dataset) = length`ï¼ˆä¸æ—¶é—´ç‚¹æ•°é‡ç›¸ç­‰ï¼‰

---

### 3. å•ä¸ªæ ·æœ¬çš„åŠ è½½è¿‡ç¨‹ (`__getitem__`)

#### åœºæ™¯ Aï¼šå†å²æ•°æ®å……è¶³ï¼ˆidx â‰¥ window_size - 1ï¼‰

**ç¤ºä¾‹ï¼šidx = 10, window_size = 5**

```python
# 1. è·å–ç›®æ ‡å¸§ï¼ˆGround Truthï¼‰
target = gt[10]  # Shape: [1, H, W]

# 2. è·å–è¾“å…¥çª—å£ï¼ˆBase Model çš„é¢„æµ‹ï¼‰
# éœ€è¦ï¼šå†å² 5 å¸§ [6, 7, 8, 9, 10]
start_idx = 10 + 1 - 5 = 6
end_idx = 10 + 1 = 11
input_chunk = pred[6:11]  # Shape: [5, H, W]
```

**è¿”å›ï¼š**
- `input_tensor`: `[5, H, W]` - è¿‡å» 5 å¸§çš„é¢„æµ‹
- `target_tensor`: `[1, H, W]` - å½“å‰å¸§çš„çœŸå®å€¼

---

#### åœºæ™¯ Bï¼šå†å²æ•°æ®ä¸è¶³ï¼ˆidx < window_size - 1ï¼‰

**ç¤ºä¾‹ï¼šidx = 2, window_size = 5**

```python
# 1. è·å–ç›®æ ‡å¸§
target = gt[2]  # Shape: [1, H, W]

# 2. è®¡ç®—éœ€è¦çš„å†å²çª—å£
# ç†æƒ³æƒ…å†µï¼šéœ€è¦ [-2, -1, 0, 1, 2]
# å®é™…æƒ…å†µï¼šåªèƒ½å–åˆ° [0, 1, 2]

# 3. è¾¹ç¼˜å¤åˆ¶å¡«å……ï¼ˆEdge Paddingï¼‰
valid_chunk = pred[0:3]      # å–èƒ½å–åˆ°çš„éƒ¨åˆ† [0, 1, 2]
pad_len = 5 - 3 = 2          # ç¼ºå°‘ 2 å¸§
first_frame = valid_chunk[0] # å¤åˆ¶ç¬¬ 0 å¸§
pad_chunk = repeat(first_frame, 2)  # Shape: [2, H, W]

# 4. æ‹¼æ¥
input_chunk = concat([pad_chunk, valid_chunk])  
# ç»“æœï¼š[pad_frame, pad_frame, frame_0, frame_1, frame_2]
# Shape: [5, H, W]
```

**å¡«å……ç­–ç•¥è¯´æ˜ï¼š**
- âœ… **è¾¹ç¼˜å¤åˆ¶ï¼ˆEdge Paddingï¼‰**ï¼šå¤åˆ¶ç¬¬ä¸€å¸§ï¼Œä¿æŒä¿¡å·è¿ç»­æ€§
- âŒ é›¶å¡«å……ä¼šå¯¼è‡´çªå˜ï¼Œä¸åˆ©äºæ¨¡å‹å­¦ä¹ 

---

### 4. DataLoader æ‰¹å¤„ç†

```python
loader = DataLoader(
    dataset,
    batch_size=64,
    shuffle=True,
    num_workers=4
)
```

**æ‰¹å¤„ç†åçš„å½¢çŠ¶ï¼š**
- `input_batch`: `[64, 5, H, W]` - 64 ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬ 5 å¸§
- `target_batch`: `[64, 1, H, W]` - 64 ä¸ªç›®æ ‡å¸§

---

## å‰å‘ä¼ æ’­è¿‡ç¨‹

### æ¨¡å‹æ¶æ„æ¦‚è§ˆ

```
è¾“å…¥: [Batch, T=5, H, W]
  â”‚
  â”œâ”€â†’ [æ­¥éª¤ 1] æå–å½“å‰å¸§ä½œä¸ºåŸºå‡†
  â”‚      base_current: [Batch, 1, H, W]
  â”‚
  â”œâ”€â†’ [æ­¥éª¤ 2] æ—¶åŸŸå·ç§¯æ ¸èåˆ
  â”‚      temporal_kernel (Conv2d: Tâ†’C, k=1)
  â”‚      è¾“å‡º: [Batch, C=64, H, W]
  â”‚
  â”œâ”€â†’ [æ­¥éª¤ 3] ç©ºé—´ç‰¹å¾æ•´åˆ
  â”‚      spatial_body (è†¨èƒ€å·ç§¯ + GroupNorm + SiLU)
  â”‚      è¾“å‡º: [Batch, C=64, H, W]
  â”‚
  â”œâ”€â†’ [æ­¥éª¤ 4] æ®‹å·®æŠ•å½±
  â”‚      projector (Conv2d: Câ†’1, k=1)
  â”‚      è¾“å‡º: residual: [Batch, 1, H, W]
  â”‚
  â””â”€â†’ [æ­¥éª¤ 5] æ®‹å·®è¿æ¥
        è¾“å‡º: base_current + residual
        æœ€ç»ˆ: [Batch, 1, H, W]
```

---

### è¯¦ç»†æ­¥éª¤è§£æ

#### æ­¥éª¤ 1ï¼šæå–å½“å‰å¸§åŸºå‡†

```python
base_current = x[:, -1:, :, :]
# è¾“å…¥: [Batch, 5, H, W]
# è¾“å‡º: [Batch, 1, H, W] - å–æœ€åä¸€å¸§ï¼ˆå½“å‰æ—¶åˆ»ï¼‰
```

**ä½œç”¨ï¼š**
- ä¿ç•™ Base Model çš„åŸå§‹é¢„æµ‹ä½œä¸ºåŸºå‡†
- æ¨¡å‹å­¦ä¹ çš„æ˜¯**æ®‹å·®ä¿®æ­£**ï¼Œè€Œä¸æ˜¯é‡æ–°é¢„æµ‹

---

#### æ­¥éª¤ 2ï¼šæ—¶åŸŸå·ç§¯æ ¸èåˆ

```python
feat = self.temporal_kernel(x)
# è¾“å…¥: [Batch, 5, H, W]
# å·ç§¯: Conv2d(in_channels=5, out_channels=64, kernel_size=1)
# è¾“å‡º: [Batch, 64, H, W]
```

**æ ¸å¿ƒæœºåˆ¶ï¼š**
è™½ç„¶ `kernel_size=1`ï¼ˆç©ºé—´ä¸Šä¸å·ç§¯ï¼‰ï¼Œä½†å› ä¸ºè¾“å…¥é€šé“æ•°æ˜¯ 5ï¼ˆæ—¶é—´ç»´åº¦ï¼‰ï¼Œæ‰€ä»¥ï¼š

å¯¹äºç©ºé—´ä½ç½® `(i, j)`ï¼š
```
feat[i, j] = wâ‚€ Ã— x[t-4, i, j] + 
             wâ‚ Ã— x[t-3, i, j] + 
             wâ‚‚ Ã— x[t-2, i, j] + 
             wâ‚ƒ Ã— x[t-1, i, j] + 
             wâ‚„ Ã— x[t,   i, j] + bias
```

è¿™ç›¸å½“äºä¸€ä¸ª**å¯å­¦ä¹ çš„æ—¶åŸŸ FIR æ»¤æ³¢å™¨**ï¼Œè‡ªåŠ¨å­¦ä¹ å¦‚ä½•èåˆå†å²ä¿¡æ¯ã€‚

---

#### æ­¥éª¤ 3ï¼šç©ºé—´ç‰¹å¾æ•´åˆ

```python
feat = self.spatial_body(feat)
# è¾“å…¥: [Batch, 64, H, W]
# è¾“å‡º: [Batch, 64, H, W]
```

**ç©ºé—´ç‰¹å¾æå–ç½‘ç»œï¼š**

```python
Sequential(
    # ç¬¬ä¸€å±‚ï¼šæ ‡å‡† 3Ã—3 å·ç§¯ï¼ˆæ•æ‰å±€éƒ¨è¿æ¥ï¼‰
    Conv2d(64, 64, kernel_size=3, padding=1, dilation=1)
    GroupNorm(8, 64)  # å½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒ
    SiLU()            # æ¿€æ´»å‡½æ•°
    
    # ç¬¬äºŒå±‚ï¼šè†¨èƒ€å·ç§¯ï¼ˆæ‰©å¤§æ„Ÿå—é‡ï¼Œæ•æ‰è¿œè·ç¦»è¿æ¥ï¼‰
    Conv2d(64, 64, kernel_size=3, padding=2, dilation=2)
    GroupNorm(8, 64)
    SiLU()
)
```

**è®¾è®¡ç†å¿µï¼š**
- **dilation=1**ï¼šæ•æ‰ç›¸é‚»è„‘åŒºçš„è¿æ¥
- **dilation=2**ï¼šæ•æ‰æ›´è¿œè·ç¦»çš„è„‘åŒºè¿æ¥ï¼ˆç¬¦åˆ fMRI çš„ç©ºé—´ç›¸å…³æ€§ï¼‰
- **GroupNorm**ï¼šæ›¿ä»£ BatchNormï¼Œé€‚åˆå°æ‰¹é‡è®­ç»ƒ

---

#### æ­¥éª¤ 4ï¼šæ®‹å·®æŠ•å½±

```python
residual = self.projector(feat)
# è¾“å…¥: [Batch, 64, H, W]
# å·ç§¯: Conv2d(64, 1, kernel_size=1)
# è¾“å‡º: [Batch, 1, H, W]
```

**é›¶åˆå§‹åŒ–ç­–ç•¥ï¼š**
```python
nn.init.constant_(self.projector.weight, 0)
nn.init.constant_(self.projector.bias, 0)
```

**ä½œç”¨ï¼š**
- è®­ç»ƒåˆæœŸï¼š`residual â‰ˆ 0`ï¼Œæ‰€ä»¥ `output â‰ˆ base_current`
- ä¿è¯æ¨¡å‹ä» Base Model çš„é¢„æµ‹å¼€å§‹ï¼Œé€æ­¥å­¦ä¹ ä¿®æ­£
- é¿å…è®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šæ€§

---

#### æ­¥éª¤ 5ï¼šæ®‹å·®è¿æ¥

```python
output = base_current + residual
# base_current: [Batch, 1, H, W] - Base Model çš„é¢„æµ‹
# residual:     [Batch, 1, H, W] - å­¦ä¹ åˆ°çš„ä¿®æ­£é‡
# è¾“å‡º:         [Batch, 1, H, W] - ç²¾ç‚¼åçš„é¢„æµ‹
```

**æ•°å­¦è¡¨è¾¾ï¼š**
```
Refined(t) = Base_Prediction(t) + Î”(t)
```

å…¶ä¸­ `Î”(t)` æ˜¯æ¨¡å‹åŸºäºå†å²çª—å£ `[t-4, ..., t]` å­¦ä¹ åˆ°çš„ä¿®æ­£é¡¹ã€‚

---

## å®Œæ•´æµç¨‹å›¾

### è®­ç»ƒæ—¶çš„æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®åŠ è½½é˜¶æ®µ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    H5æ–‡ä»¶: pred[0:1000], gt[0:1000]
        â”‚
        â”œâ”€â†’ Dataset.__getitem__(idx=10)
        â”‚      â”œâ”€â†’ å– pred[6:11] â†’ [5, H, W]
        â”‚      â””â”€â†’ å– gt[10] â†’ [1, H, W]
        â”‚
        â””â”€â†’ DataLoader æ‰¹å¤„ç†
              â””â”€â†’ batch: [64, 5, H, W], target: [64, 1, H, W]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰å‘ä¼ æ’­é˜¶æ®µ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    è¾“å…¥: x = [64, 5, H, W]
        â”‚
        â”œâ”€â†’ æå–åŸºå‡†: base_current = x[:, -1:] â†’ [64, 1, H, W]
        â”‚
        â”œâ”€â†’ æ—¶åŸŸèåˆ: temporal_kernel(x) â†’ [64, 64, H, W]
        â”‚      (å­¦ä¹ å¦‚ä½•ç»„åˆ 5 å¸§å†å²ä¿¡æ¯)
        â”‚
        â”œâ”€â†’ ç©ºé—´æ•´åˆ: spatial_body(...) â†’ [64, 64, H, W]
        â”‚      (æå–ç©ºé—´ç‰¹å¾ï¼Œæ•æ‰è„‘åŒºè¿æ¥)
        â”‚
        â”œâ”€â†’ æ®‹å·®æŠ•å½±: projector(...) â†’ [64, 1, H, W]
        â”‚      (è®¡ç®—ä¿®æ­£é‡)
        â”‚
        â””â”€â†’ æ®‹å·®è¿æ¥: base_current + residual â†’ [64, 1, H, W]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æŸå¤±è®¡ç®—é˜¶æ®µ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    é¢„æµ‹: pred = [64, 1, H, W]
    çœŸå®: target = [64, 1, H, W]
        â”‚
        â””â”€â†’ PhysiologicalLoss(pred, target)
              â”œâ”€â†’ MSE Loss
              â”œâ”€â†’ SSIM Loss
              â””â”€â†’ CCC Loss
```

---

### æ¨ç†æ—¶çš„æ•°æ®æµ

```
H5æ–‡ä»¶: pred[0:1000] (Base Model é¢„æµ‹)
    â”‚
    â””â”€â†’ é€å¸§æ¨ç† (Batch=1)
          â”‚
          â”œâ”€â†’ å¸§ i=0: å¡«å…… â†’ [1, 5, H, W] â†’ æ¨¡å‹ â†’ [1, 1, H, W]
          â”œâ”€â†’ å¸§ i=1: å¡«å…… â†’ [1, 5, H, W] â†’ æ¨¡å‹ â†’ [1, 1, H, W]
          â”œâ”€â†’ ...
          â””â”€â†’ å¸§ i=999: [1, 5, H, W] â†’ æ¨¡å‹ â†’ [1, 1, H, W]
                â”‚
                â””â”€â†’ ä¿å­˜åˆ° refined.h5
```

---

## å…³é”®è®¾è®¡è¦ç‚¹

### 1. æ»‘åŠ¨çª—å£æœºåˆ¶
- ä½¿ç”¨å›ºå®šå¤§å°çš„æ—¶åŸŸçª—å£ï¼ˆé»˜è®¤ 5 å¸§ï¼‰
- æ¯æ¬¡é¢„æµ‹åªä¾èµ–æœ€è¿‘çš„å†å²ä¿¡æ¯
- æ”¯æŒåœ¨çº¿æ¨ç†ï¼Œæ— éœ€å…¨åºåˆ—

### 2. æ®‹å·®å­¦ä¹ 
- ä¸æ˜¯é‡æ–°é¢„æµ‹ï¼Œè€Œæ˜¯ä¿®æ­£ Base Model çš„è¾“å‡º
- è®­ç»ƒæ›´ç¨³å®šï¼Œæ”¶æ•›æ›´å¿«
- å¯ä»¥ä¸ä»»ä½• Base Model é…åˆä½¿ç”¨

### 3. æ—¶åŸŸ + ç©ºé—´è”åˆå»ºæ¨¡
- **æ—¶åŸŸå·ç§¯æ ¸**ï¼šå­¦ä¹ æ—¶é—´ä¾èµ–å…³ç³»
- **ç©ºé—´å·ç§¯ç½‘ç»œ**ï¼šå­¦ä¹ ç©ºé—´ç›¸å…³æ€§
- ç¬¦åˆ fMRI æ•°æ®çš„æ—¶é—´-ç©ºé—´ç‰¹æ€§

### 4. è¾¹ç•Œå¤„ç†
- ä½¿ç”¨è¾¹ç¼˜å¤åˆ¶å¡«å……ï¼Œè€Œéé›¶å¡«å……
- ä¿è¯ä¿¡å·è¿ç»­æ€§
- æ”¯æŒé¢„æµ‹æ‰€æœ‰æ—¶é—´ç‚¹ï¼ˆåŒ…æ‹¬å‰å‡ ä¸ªï¼‰

---

## ç¤ºä¾‹ä»£ç è¿è¡Œæµç¨‹

```python
# 1. åˆå§‹åŒ–
dataset = FMRI_H5_Dataset("./data/train_data.h5", window_size=5)
loader = DataLoader(dataset, batch_size=64, shuffle=True)
model = NeuroRefiner(config).to(device)

# 2. è®­ç»ƒå¾ªç¯
for x, y in loader:  # x: [64, 5, H, W], y: [64, 1, H, W]
    x, y = x.to(device), y.to(device)
    
    # å‰å‘ä¼ æ’­
    pred = model(x)  # pred: [64, 1, H, W]
    
    # è®¡ç®—æŸå¤±
    loss = criterion(pred, y)
    
    # åå‘ä¼ æ’­
    loss.backward()
    optimizer.step()
```

---

## æ€»ç»“

**æ•°æ®åŠ è½½ç‰¹ç‚¹ï¼š**
- âœ… æ»‘åŠ¨çª—å£é‡‡æ ·ï¼Œæ”¯æŒæ‰€æœ‰æ—¶é—´ç‚¹
- âœ… æ™ºèƒ½è¾¹ç•Œå¡«å……ï¼Œä¿è¯æ•°æ®è¿ç»­æ€§
- âœ… é«˜æ•ˆ H5 è¯»å–ï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®

**å‰å‘ä¼ æ’­ç‰¹ç‚¹ï¼š**
- âœ… æ—¶åŸŸ-ç©ºé—´è”åˆå»ºæ¨¡
- âœ… æ®‹å·®å­¦ä¹ æœºåˆ¶
- âœ… é›¶åˆå§‹åŒ–ä¿è¯è®­ç»ƒç¨³å®šæ€§

è¿™ä¸ªè®¾è®¡ä½¿å¾—æ¨¡å‹æ—¢èƒ½åˆ©ç”¨å†å²æ—¶åºä¿¡æ¯ï¼Œåˆèƒ½æ•æ‰ç©ºé—´ç›¸å…³æ€§ï¼Œéå¸¸é€‚åˆ fMRI/HRF æ•°æ®çš„ç²¾ç»†åŒ–å¤„ç†ä»»åŠ¡ã€‚

